digraph EKSArchitecture {
    // Graph settings
    rankdir=TB;
    splines=polyline;
    nodesep=0.5;
    ranksep=0.6;
    fontname="Helvetica";
    fontsize=14;
    compound=true;
    newrank=true;

    // Default node styling
    node [shape=box style="filled,rounded" fontname="Helvetica" fontsize=11];
    edge [fontname="Helvetica" fontsize=9 penwidth=1.5];

    // External actors - positioned at top
    subgraph cluster_external {
        label="External Actors";
        style=filled;
        fillcolor="#e8e8e8";
        color="#666666";

        github [label="GitHub Actions\n(CI/CD)" shape=box fillcolor="#24292e" fontcolor=white];
        users [label="Users/Clients" shape=ellipse fillcolor="#f0f0f0"];
        developer [label="Developer\n(kubectl/eksctl)" shape=ellipse fillcolor="#f0f0f0"];
    }

    // AWS Cloud
    subgraph cluster_aws {
        label="AWS Cloud (eu-west-1)";
        labelloc=t;
        style=filled;
        fillcolor="#f5f5f5";
        color="#232f3e";
        fontcolor="#232f3e";
        fontsize=16;
        penwidth=2;

        // AWS Managed Services
        subgraph cluster_aws_managed {
            label="AWS Managed Services\n(fully managed by AWS, no infrastructure to maintain)";
            style=filled;
            fillcolor="#232f3e";
            fontcolor=white;
            fontsize=10;

            ecr [label="ghcr.io\n(Container Registry)" fillcolor="#3b48cc" fontcolor=white];
            eks_control [label="EKS Control Plane\nesade-teaching\nK8s 1.32" shape=box3d fillcolor="#FF9900" fontcolor=white];
        }

        // VPC
        subgraph cluster_vpc {
            label="VPC: 192.168.0.0/16\n(isolated virtual network for all cluster resources)";
            labelloc=t;
            style=filled;
            fillcolor="#d4edda";
            color="#28a745";
            fontsize=12;

            // Internet Gateway
            igw [label="Internet Gateway\n━━━━━━━━━━━━━━\nEntry/exit point\nfor internet traffic" shape=diamond fillcolor="#f8d7da" color="#dc3545"];

            // NAT Gateway
            nat [label="NAT Gateway\n━━━━━━━━━━━━━━\nAllows private subnets\noutbound internet access\n(no inbound)" shape=diamond fillcolor="#fff3cd" color="#856404"];

            // Public Subnets
            subgraph cluster_public {
                label="Public Subnets\n(directly accessible from internet, hosts load balancers)";
                style=filled;
                fillcolor="#cce5ff";
                color="#0066cc";
                fontsize=10;

                pub_1a [label="eu-west-1a\n192.168.64.0/19" shape=folder fillcolor="#e8f4fd"];
                pub_1b [label="eu-west-1b\n192.168.0.0/19" shape=folder fillcolor="#e8f4fd"];
                pub_1c [label="eu-west-1c\n192.168.32.0/19" shape=folder fillcolor="#e8f4fd"];

                elb [label="AWS ELB\n(LoadBalancer)" shape=hexagon fillcolor="#FF9900" fontcolor=white];
            }

            // Private Subnets with Node Group
            subgraph cluster_private {
                label="Private Subnets\n(no direct internet access, protected worker nodes)";
                style=filled;
                fillcolor="#f5c6cb";
                color="#721c24";
                fontsize=10;

                priv_1a [label="eu-west-1a\n192.168.160.0/19" shape=folder fillcolor="#fce4e6"];
                priv_1b [label="eu-west-1b\n192.168.96.0/19" shape=folder fillcolor="#fce4e6"];
                priv_1c [label="eu-west-1c\n192.168.128.0/19" shape=folder fillcolor="#fce4e6"];

                // Node Group
                subgraph cluster_nodegroup {
                    label="Node Group: students\n(EC2 instances running Kubernetes, auto-scales 1-3 nodes)";
                    style=filled;
                    fillcolor="#e2e3e5";
                    color="#6c757d";
                    fontsize=10;

                    node1 [label="Node 1\nt3.medium\nAmazon Linux 2023\ncontainerd 2.1.5" shape=box3d fillcolor="#ffc107"];
                    node2 [label="Node 2\nt3.medium\nAmazon Linux 2023\ncontainerd 2.1.5" shape=box3d fillcolor="#ffc107"];
                }

                // Application Layer (in K8s) - INSIDE private subnets
                subgraph cluster_app {
                    label="Namespace: hello-world\n(Kubernetes logical isolation for the application)";
                    style=filled;
                    fillcolor="#d1ecf1";
                    color="#0c5460";
                    fontsize=10;

                    pod1 [label="Pod 1\nhello-world" shape=box fillcolor="#28a745" fontcolor=white];
                    pod2 [label="Pod 2\nhello-world" shape=box fillcolor="#28a745" fontcolor=white];
                    svc [label="Service\n(LoadBalancer)" shape=hexagon fillcolor="#6f42c1" fontcolor=white];
                }
            }

            // EKS Add-ons
            subgraph cluster_addons {
                label="EKS Add-ons\n(AWS-managed Kubernetes components running on nodes)";
                style=filled;
                fillcolor="#e9ecef";
                fontsize=10;

                vpccni [label="vpc-cni\nPod Networking" shape=component fillcolor="#17a2b8" fontcolor=white];
                coredns [label="CoreDNS\nCluster DNS" shape=component fillcolor="#17a2b8" fontcolor=white];
                kubeproxy [label="kube-proxy\nService Proxy" shape=component fillcolor="#17a2b8" fontcolor=white];
                metrics [label="metrics-server\nResource Metrics" shape=component fillcolor="#17a2b8" fontcolor=white];
            }
        }

        // CloudFormation Stacks
        subgraph cluster_cfn {
            label="CloudFormation Stacks\n(generated by eksctl from eksctl-cluster.yaml)";
            style=filled;
            fillcolor="#f8f9fa";
            fontsize=11;

            cfn_cluster [label="eksctl-esade-teaching-cluster\n━━━━━━━━━━━━━━━━━━━━━━\nSource: metadata section\n━━━━━━━━━━━━━━━━━━━━━━\nVPC, Control Plane, IAM,\nSubnets, Gateways" shape=note fillcolor="#ffc107"];
            cfn_nodegroup [label="eksctl-esade-teaching-nodegroup-students\n━━━━━━━━━━━━━━━━━━━━━━\nSource: managedNodeGroups[0]\n━━━━━━━━━━━━━━━━━━━━━━\nEC2, ASG, Launch Template" shape=note fillcolor="#ffc107"];
        }
    }

    // Legend at bottom with horizontal layout
    subgraph cluster_legend {
        label="Connection Types Legend";
        labelloc=t;
        style=filled;
        fillcolor="#ffffff";
        color="#333333";
        fontsize=12;
        penwidth=2;
        rank=max;

        // Row 1
        leg1a [label="" shape=point width=0.1];
        leg1b [label="HTTP Traffic\n(user requests)" shape=plaintext fontsize=9];
        leg2a [label="" shape=point width=0.1];
        leg2b [label="Control Plane\n(kubectl, kubelet)" shape=plaintext fontsize=9];
        leg3a [label="" shape=point width=0.1];
        leg3b [label="CI/CD Pipeline\n(GitHub Actions)" shape=plaintext fontsize=9];
        leg4a [label="" shape=point width=0.1];
        leg4b [label="Image Pull\n(container registry)" shape=plaintext fontsize=9];

        // Row 2
        leg5a [label="" shape=point width=0.1];
        leg5b [label="NAT Outbound\n(private to internet)" shape=plaintext fontsize=9];
        leg6a [label="" shape=point width=0.1];
        leg6b [label="Provisioning\n(CloudFormation)" shape=plaintext fontsize=9];
        leg7a [label="" shape=point width=0.1];
        leg7b [label="Pod Placement\n(runs on node)" shape=plaintext fontsize=9];

        // Legend edges with actual styles - Row 1
        leg1a -> leg1b [color="#22863a" penwidth=2.5 arrowhead=none];
        leg2a -> leg2b [color="#0366d6" penwidth=2 style=dashed arrowhead=none];
        leg3a -> leg3b [color="#6f42c1" penwidth=2 arrowhead=none];
        leg4a -> leg4b [color="#e36209" penwidth=1.5 style=dashed arrowhead=none];

        // Legend edges with actual styles - Row 2
        leg5a -> leg5b [color="#b08800" penwidth=1.5 style=dashed arrowhead=none];
        leg6a -> leg6b [color="#586069" penwidth=2 style=dotted arrowhead=none];
        leg7a -> leg7b [color="#24292e" penwidth=2.5 style=dotted arrowhead=none];

        // Horizontal layout for row 1
        {rank=same; leg1a; leg1b; leg2a; leg2b; leg3a; leg3b; leg4a; leg4b;}
        // Horizontal layout for row 2
        {rank=same; leg5a; leg5b; leg6a; leg6b; leg7a; leg7b;}

        // Connect rows
        leg1b -> leg5a [style=invis];
    }

    // =====================
    // CONNECTIONS BY TYPE
    // =====================

    // GREEN: User HTTP traffic flow
    users -> igw [label="HTTP" color="#22863a" fontcolor="#22863a" penwidth=2.5];
    igw -> elb [color="#22863a" penwidth=2.5];
    elb -> svc [label="traffic" color="#22863a" fontcolor="#22863a" penwidth=2.5];
    svc -> pod1 [color="#22863a" penwidth=2];
    svc -> pod2 [color="#22863a" penwidth=2];

    // BLUE: Control plane / kubectl
    developer -> eks_control [label="kubectl\neksctl" color="#0366d6" fontcolor="#0366d6" style=dashed penwidth=2];
    eks_control -> node1 [label="kubelet" color="#0366d6" fontcolor="#0366d6" style=dashed penwidth=1.5];
    eks_control -> node2 [label="kubelet" color="#0366d6" fontcolor="#0366d6" style=dashed penwidth=1.5];

    // PURPLE: CI/CD pipeline
    github -> ecr [label="push image" color="#6f42c1" fontcolor="#6f42c1" penwidth=2];
    github -> eks_control [label="deploy" color="#6f42c1" fontcolor="#6f42c1" style=dashed penwidth=2];

    // ORANGE: Container image pulls
    ecr -> node1 [label="pull image" color="#e36209" fontcolor="#e36209" style=dashed penwidth=1.5];
    ecr -> node2 [color="#e36209" style=dashed penwidth=1.5];

    // AMBER: Outbound NAT traffic
    node1 -> nat [label="outbound" color="#b08800" fontcolor="#b08800" style=dashed penwidth=1.5];
    node2 -> nat [color="#b08800" style=dashed penwidth=1.5];
    nat -> igw [color="#b08800" style=dashed penwidth=1.5];

    // GRAY DOTTED: Pod placement (logical, not network)
    pod1 -> node1 [label="runs on" color="#24292e" fontcolor="#24292e" style=dotted penwidth=2.5 dir=none];
    pod2 -> node2 [label="runs on" color="#24292e" fontcolor="#24292e" style=dotted penwidth=2.5 dir=none];

    // DARK GRAY DOTTED: CloudFormation provisioning
    cfn_cluster -> eks_control [label="creates" color="#586069" fontcolor="#586069" style=dotted penwidth=2];
    cfn_cluster -> igw [color="#586069" style=dotted penwidth=2];
    cfn_cluster -> nat [color="#586069" style=dotted penwidth=2];
    cfn_nodegroup -> node1 [label="creates" color="#586069" fontcolor="#586069" style=dotted penwidth=2];
    cfn_nodegroup -> node2 [color="#586069" style=dotted penwidth=2];

    // Add-ons run on nodes (invisible layout edges)
    vpccni -> node1 [style=invis];
    coredns -> node1 [style=invis];
    kubeproxy -> node1 [style=invis];
    metrics -> node1 [style=invis];

    // Layout hints - keep legend at bottom
    node2 -> leg1a [style=invis lhead=cluster_legend];
}
